<section>
    <hr>
    <div id="ativas">
        <h5 class="display-5">Assinaturas ativas</h5>

        <hr>

        <div id="filters">
            <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#modal-filter">Filtrar</button>
        
            <div class="modal fade" id="modal-filter" tabindex="-1" role="dialog" aria-labelledby="modal-filter-title" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content bg-dark">
                        <div class="modal-header">
                            <h5 class="modal-title text-light">Filtrar Busca</h5>
                            <button type="button" class="btn btn-close bg-white" data-dismiss="modal" aria-label="Close"></button>
                        </div>
        
                        <div class="modal-body">
                            <div class="container">
                                <h5>Por lista</h5>

                                <ul>
                                    <input type="checkbox" name="list" value="vai_volta" class="form-check-input bg-dark" id="vai_volta">
                                    <label class="form-check-label" for="vai_volta">Vai e Volta</label> 
                                
                                    <br>
        
                                    <input type="checkbox" name="list" value="pernoite" class="form-check-input bg-dark" id="pernoite">
                                    <label class="form-check-label" for="pernoite">Pernoite</label>  
                                
                                    <br>
        
                                    <input type="checkbox" name="list" value="saida" class="form-check-input bg-dark" id="saida">
                                    <label class="form-check-label" for="saida">Saída</label>
                                </ul>
                            </div>

                            <hr>
    
                            <div class="container">
                                <h5>Por data</h5>
    
                                <ul>
                                    <label class="form-check-label" for="date_initial">De:</label> 
                                    <input type="date" name="data_initial" class="form-control bg-dark text-light" id="date_initial" onchange="fillFinalHourInput()">
                                
                                    <br>
        
                                    <label class="form-check-label" for="date_final">Até:</label>
                                    <input type="date" name="data_final" class="form-control bg-dark text-light" id="date_final">
                                </ul>
                            </div>
                        </div>
        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Fechar</button>
                            <button type="button" class="btn btn-outline-success" onclick="clearFilters()" data-dismiss="modal">
                                Limpar Filtros
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="applyEffects(true)" data-dismiss="modal">Filtrar</button>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>

        <div class="list-group" id="res">
            {{no_itens}}
            {{not_found}}
        </div>
    </div>
</section>

<script>
    const results = [{{itens}}];
    let actualOrder = null;
    let activesFilters = [];

    window.addEventListener("DOMContentLoaded", (event) => {
        createTable(results);
    });

    function createTable(itens, allItens = true)
    {
        let res = document.getElementById("res");

        if (itens.length == 0)
        {
            if (allItens)
            {
                document.getElementById("no-itens").style.display = "block";
                document.getElementById("filters").style.display = "none";
            }
            
            else
            {
                document.getElementById("not-found").style.display = "block";
            }

            return; 
        }
        
        let table = document.createElement("table");
        table.setAttribute("class", "table table-dark table-bordered table-hover");
        table.setAttribute("id", "table");

        let thead = document.createElement("thead");
        let tr = document.createElement("tr");

        let th = [
            document.createElement("th"),
            document.createElement("th"), 
            document.createElement("th"),
            document.createElement("th"),
            document.createElement("th"),
        ];

        th[0].textContent = "Lista";
        th[1].textContent = "Data de saída";
        th[2].textContent = "Data de chegada";
        th[3].textContent = "Horário de saída";
        th[4].textContent = "Horário de chegada";

        let sortIcon = [];
        
        for (let i = 0; i < th.length; i++)
        {
            sortIcon.push(
                document.createElement("img")
            );

            sortIcon[i].setAttribute("src", "../resources/images/Icons/sort-down.png");
        }

        for (let i = 0; i < th.length; i++)
        {
            th[i].setAttribute("onclick", "applyEffects(false, '" + th[i].textContent + "')");
            th[i].appendChild(sortIcon[i]);
            tr.appendChild(th[i]);
        }

        thead.appendChild(tr);
        table.appendChild(thead);

        let tbody = document.createElement("tbody");

        for (let i = 0; i < itens.length; i++)
        {
            let tr = document.createElement("tr");
            tr.setAttribute("onclick", "tableClick(" + itens[i].id + ", '" + itens[i].type + "')");
            tr.style.cursor = "pointer";

            let td = [
                document.createElement("td"),
                document.createElement("td"),
                document.createElement("td"),
                document.createElement("td"),
                document.createElement("td")
            ];

            switch (itens[i].type)
            {
                case "vai_volta":
                    td[0].textContent = "Vai e Volta",
                    td[1].textContent = itens[i].data,
                    td[2].textContent = itens[i].data,
                    td[3].textContent = itens[i].horaSaida,
                    td[4].textContent = itens[i].horaChegada
                    
                    break;

                default:
                    td[0].textContent = itens[i].type == "saida" ? "Saída" : "Pernoite",
                    td[1].textContent = itens[i].dataSaida,
                    td[2].textContent = itens[i].dataChegada,
                    td[3].textContent = itens[i].horaSaida,
                    td[4].textContent = itens[i].horaChegada

                    break;
            }

            td.forEach(item => {
                tr.appendChild(item);
            })
            
            tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        res.appendChild(table);
    }

    function clearTable()
    {
        try {
            document.getElementById("table").remove();
        }
        
        catch { return }
    }

    function tableClick(id, name)
    {
        location.href = "{{URL}}/assinaturas/" + name + "/" + id;
    }

    function verifyFilters()
    {
        activesFilters = [];

        if (document.getElementById("vai_volta").checked)
        {
            activesFilters.push("vai_volta");
        }
        
        if (document.getElementById("saida").checked)
        {
            activesFilters.push("saida");
        }
        
        if (document.getElementById("pernoite").checked)
        {
            activesFilters.push("pernoite");
        }

        if (document.getElementById("date_initial").value.length > 0)
        {
            activesFilters.push(
                {
                    date: {
                        initial: document.getElementById("date_initial").value,
                        final: document.getElementById("date_final").value.length > 0 ? document.getElementById("date_final").value : document.getElementById("date_initial").value
                    }
                }
            );
        }
    }

    function filterItens()
    {
        let itens = [];

        activesFilters.forEach(item => {
            if (typeof item == "string")
            {
                let aux = results;

                aux.forEach(res => {
                    if (res.type == item)
                    {
                        itens.push(res);
                    }
                });
            }

            else
            {
                let aux = itens;
                itens = [];

                aux.forEach(res => {
                    if (res.type == "vai_volta")
                    {
                        if (item.date.initial <= res.data && item.date.final >= res.data)
                        {
                            itens.push(res);
                        }
                    }

                    else
                    {
                        if (item.date.initial <= res.dataSaida && item.date.final >= res.dataSaida)
                        {
                            itens.push(res);
                        }
                    }
                })
            }
        });

        return itens;
    }

    function clearFilters()
    {
        activesFilters = [];
        applyEffects();
    }

    function applyOrder(order)
    {
        let itens = [];

        if (actualOrder == order)
        {

        }

        else
        {
            switch (order)
            {
                case "Lista":
                    let aux = results;

                    aux.sort((a, b) => {
                        a.type.localeCompare(b.type)
                    });

                    console.log(aux);
                    itens = aux;

                    break;
            }
        }

        /*
        aluno: "1"
        ativa: "1"
        data: "25/08/2023"
        destino: "Salinas"
        horaChegada: "22:29"
        horaSaida: "11:29"
        id: "3"
        type: "vai_volta"

        ------------------------------

        aluno: "1"
        ativa: "1"
        dataChegada: "25/08/2023"
        dataSaida: "25/08/2023"
        destino: "Salinas"
        horaChegada: "22:59"
        horaSaida: "14:30"
        id: "2"
        type: "saida"
        */

        return itens;
    }

    function applyEffects(fromFilter = false, order = null)
    {
        if (fromFilter)
        {
            verifyFilters();
        }
        
        let itens = filterItens();
        /*
        if (order != null)
        {
            itens = applyOrder(order);
        }

        else if (actualOrder != null)
        {
            itens = applyOrder(actualOrder);
        }
        */
       
        clearTable();
        createTable(itens, false);
    }

    function fillFinalHourInput()
    {
        let final = document.getElementById("date_final");
        let initial = document.getElementById("date_initial");

        if (final.value.length > 0 || initial.value.length == 0)
        {
            return;
        }

        final.value = initial.value;
    }
</script>

<style>
    th {
        transition: 0.2s;
        cursor: pointer;
    }

    th img {
        float: right;
        width: 20px;
    }

    th:hover {
        background-color: rgb(71, 71, 71);
    }
</style>